{"name":"Bagheera","body":"# Bagheera #\r\n\r\nVersion: 0.5  \r\n\r\n#### REST service for Mozilla Metrics. This service currently uses Hazelcast's distributed in-memory map. The maps can be automatically persisted (Push model) using Hazelcast's persistence classes to persist the map data to various data sinks. We also now provide some consumer implementations to pull data from the maps (Push/Pull model i.e. Pub/Sub).####\r\n\r\n\r\n### Version Compatability ###\r\nThis code is built with the following assumptions.  You may get mixed results if you deviate from these versions.\r\n\r\n* [Hadoop](http://hadoop.apache.org) 0.20.2+\r\n* [HBase](http://hbase.apache.org) 0.90+\r\n* [Hazelcast](http://www.hazelcast.com/) 2.0+\r\n\r\n### Building ###\r\nTo make a jar you can do:  \r\n\r\n`mvn package`\r\n\r\nThe jar file is then located under `target`.\r\n\r\n### Running an instance ###\r\nIn order to run bagheera on another machine you will probably want to use the _dist_ assembly like so: need to deploy the following to your deployment target which I'll call `BAGHEERA_HOME`.\r\n\r\n`mvn assembly:assembly`\r\n\r\nThe zip file now under the `target` directory should be deployed to `BAGHEERA_HOME` on the remote server.\r\n\r\nTo run Bagheera you can use `bin/bagheera` or copy the init.d script by the same name from `bin/init.d` to `/etc/init.d`. The init script assumes an installation of bagheera at `/usr/lib/bagheera`, but this can be modified by changing the `BAGHEERA_HOME` variable near the top of that script. Here is an example of using the regular bagheera script:\r\n\r\n`bin/bagheera 8080 conf/hazelcast.xml.example`\r\n\r\nIf you start up multiple instances Hazelcast will auto-discover other instances assuming your network and hazelcast.xml are setup to do so.\r\n\r\n### REST Request Format ###\r\n\r\nBagheera takes POST data on _/map/mymapname/unique-id_. Depending on how _mymapname_ is configured in the Hazelcast configuration file, it may write to different sources. That is explained further below.\r\n\r\nHere's a quick rundown of HTTP return codes that Bagheera could send back (this isn't comprehensive but rather the most common ones):\r\n\r\n* 201 Created - returned if everything was submitted successfully (default)\r\n* 406 Not Acceptable - returned if the POST failed validation in some manner\r\n* 500 Server Error - something went horribly wrong and you should check the logs\r\n\r\n### Hazelcast HBaseMapStore Configuration ###\r\n\r\nSuppose you've created a table called 'mytable' in HBase like so:\r\n\r\n`create 'mytable', {NAME => 'data', COMPRESSION => 'LZO', VERSIONS => '1', TTL => '2147483647', BLOCKSIZE => '65536', IN_MEMORY => 'false', BLOCKCACHE => 'true'}`\r\n\r\nAll you need to do is add a section like this to the hazelcast.xml configuration file:\r\n\r\n\t<map name=\"mytable\">\r\n\t\t<time-to-live-seconds>20</time-to-live-seconds>\r\n\t\t<backup-count>1</backup-count>\r\n\t\t<eviction-policy>NONE</eviction-policy>\r\n\t\t<max-size>0</max-size>\r\n\t\t<eviction-percentage>25</eviction-percentage>\r\n\t\t<merge-policy>hz.ADD_NEW_ENTRY</merge-policy>\r\n\t\t<!-- HBaseMapStore -->\r\n\t\t<map-store enabled=\"true\">\r\n\t\t\t<class-name>com.mozilla.bagheera.hazelcast.persistence.HBaseMapStore</class-name>\r\n\t\t\t<write-delay-seconds>5</write-delay-seconds>\r\n\t\t\t<properties>\r\n\t\t\t\t<property name=\"hazelcast.hbase.pool.size\">20</property>\r\n\t\t\t\t<property name=\"hazelcast.hbase.table\">mytable</property>\r\n\t\t\t\t<property name=\"hazelcast.hbase.column.family\">data</property>\r\n\t\t\t\t<property name=\"hazelcast.hbase.column.qualifier\">json</property>\r\n\t\t\t</properties>\r\n\t\t</map-store>\r\n\t</map>\r\n\r\nNotice you can tweak the HBase connection pool size, table and column names as needed for different maps.\r\n\r\n### Hazelcast SequenceFileMapStore/TextFileMapStore Configuration ###\r\n\r\nIf you want to configure a Hazelcast Map to persist data to HDFS you can use one of two implementations of HdfsMapStore. The SequenceFileMapStore will write a SequenceFile with Text key/value pairs and the TextFileMapStore will write only values ignoring the key altogether. SequenceFileMapStore will always use block compression whereas TextFileMapStore doesn't use any compression. In the future we may add support for more compression codecs or alternative file formats. Both MapStores will rollover and write new files every day or when _hazelcast.hdfs.max.filesize_ is reached. They will write files to the directory _hazelcast.hdfs.basedir/hazelcast.hdfs.dateformat/UUID_. Please note that _hazelcast.hdfs.max.filesize_ is only checked against a bytes written counter and not the actual filesize in HDFS. Actual filesize's will probably be much smaller than this number when using compression. Here is an example section using SequenceFileMapStore from hazelcast.xml configuration:\r\n\r\n\t<map name=\"mymapname\">\r\n\t\t<time-to-live-seconds>20</time-to-live-seconds>\r\n\t\t<backup-count>1</backup-count>\r\n\t\t<eviction-policy>NONE</eviction-policy>\r\n\t\t<max-size>0</max-size>\r\n\t\t<eviction-percentage>25</eviction-percentage>\r\n\t\t<merge-policy>hz.ADD_NEW_ENTRY</merge-policy>\r\n\t\t<!-- HdfsMapStore -->\r\n\t\t<map-store enabled=\"true\">\r\n\t\t\t<class-name>com.mozilla.bagheera.hazelcast.persistence.SequenceFileMapStore</class-name>\r\n\t\t\t<write-delay-seconds>5</write-delay-seconds>\r\n\t\t\t<properties>\r\n\t\t\t\t<property name=\"hazelcast.hdfs.basedir\">/bagheera</property>\r\n\t\t\t\t<property name=\"hazelcast.hdfs.dateformat\">yyyy-MM-dd</property>\r\n\t\t\t\t<property name=\"hazelcast.hdfs.max.filesize\">1073741824</property>\r\n\t\t\t</properties>\r\n\t\t</map-store>\r\n\t</map>\r\n\r\n### Hazelcast CompositeMapStore Configuration ###\r\n\r\nThe idea behind this store is that if you have data being inserted into HBase already you could post a row ID via REST to a map. Once the ID is received and the MapStore persistence is triggered we then want to take a column value from a HBase column and send that value to ElasticSearch for indexing. Here is an example section using this MapStore from hazelcast.xml configuration:\r\n\r\n\t<map name=\"mymapname\">\r\n\t\t<time-to-live-seconds>20</time-to-live-seconds>\r\n\t\t<backup-count>1</backup-count>\r\n\t\t<eviction-policy>NONE</eviction-policy>\r\n\t\t<max-size>0</max-size>\r\n\t\t<eviction-percentage>25</eviction-percentage>\r\n\t\t<merge-policy>hz.ADD_NEW_ENTRY</merge-policy>\r\n\t\t<!-- CompositeMapStore -->\r\n\t\t<map-store enabled=\"true\">\r\n\t\t\t<class-name>com.mozilla.bagheera.hazelcast.persistence.CompositeMapStore</class-name>\r\n\t\t\t<write-delay-seconds>5</write-delay-seconds>\r\n\t\t\t<properties>\r\n\t\t\t\t<property name=\"hazelcast.composite.load.class.name\">com.mozilla.bagheera.hazelcast.persistence.HBaseMapStore</property>\r\n\t\t\t\t<property name=\"hazelcast.composite.store.class.name\">com.mozilla.bagheera.hazelcast.persistence.ElasticSearchMapStore</property>\r\n\t\t\t\t<property name=\"hazelcast.elasticsearch.config.path\">elasticsearch-socorro.yml</property>\r\n\t\t\t\t<property name=\"hazelcast.elasticsearch.index\">socorro</property>\r\n\t\t\t\t<property name=\"hazelcast.elasticsearch.type.name\">crash_reports</property>\r\n\t\t\t\t<property name=\"hazelcast.hbase.pool.size\">20</property>\r\n\t\t\t\t<property name=\"hazelcast.hbase.table\">crash_reports</property>\r\n\t\t\t\t<property name=\"hazelcast.hbase.column.family\">processed_data</property>\r\n\t\t\t\t<property name=\"hazelcast.hbase.column.qualifier\">json</property>\r\n\t\t\t</properties>\r\n\t\t</map-store>\r\n\t</map>\r\n\r\nUnfortunately for now you cannot use the same type of MapStore as both the load MapStore and store MapStore (i.e. two HBaseMapStore(s)), because the configuration parameters don't allow for it. We hope to find a somewhat clean solution for this in the future.\r\n\r\n### Hazelcast MultipleMapStore Configuration ###\r\nThis store is for when you have data you want to store in multiple data stores. Unlike CompositeMapStore this doesn't retrieve anything it only stores to all configured MapStore(s). Here is an example configuration using ElasticSearch and HBase:\r\n\r\n\t<map name=\"mymapname\">\r\n\t\t<time-to-live-seconds>20</time-to-live-seconds>\r\n\t\t<backup-count>1</backup-count>\r\n\t\t<eviction-policy>NONE</eviction-policy>\r\n\t\t<max-size>0</max-size>\r\n\t\t<eviction-percentage>25</eviction-percentage>\r\n\t\t<merge-policy>hz.ADD_NEW_ENTRY</merge-policy>\r\n\t\t<!-- MultipleMapStore -->\r\n\t\t<map-store enabled=\"true\">\r\n\t\t\t<class-name>com.mozilla.bagheera.hazelcast.persistence.MultiMapStore</class-name>\r\n\t\t\t<write-delay-seconds>5</write-delay-seconds>\r\n\t\t\t<properties>\r\n\t\t\t\t<property name=\"hazelcast.multi.store.class.name.1\">com.mozilla.bagheera.hazelcast.persistence.HBaseMapStore</property>\r\n\t\t\t\t<property name=\"hazelcast.multi.store.class.name.2\">com.mozilla.bagheera.hazelcast.persistence.ElasticSearchMapStore</property>\r\n\t\t\t\t<property name=\"hazelcast.elasticsearch.config.path\">elasticsearch-socorro.yml</property>\r\n\t\t\t\t<property name=\"hazelcast.elasticsearch.index\">socorro</property>\r\n\t\t\t\t<property name=\"hazelcast.elasticsearch.type.name\">crash_reports</property>\r\n\t\t\t\t<property name=\"hazelcast.hbase.pool.size\">20</property>\r\n\t\t\t\t<property name=\"hazelcast.hbase.table\">crash_reports</property>\r\n\t\t\t\t<property name=\"hazelcast.hbase.column.family\">processed_data</property>\r\n\t\t\t\t<property name=\"hazelcast.hbase.column.qualifier\">json</property>\r\n\t\t\t</properties>\r\n\t\t</map-store>\r\n\t</map>\r\n\r\nTo read more on Hazelcast configuration in general [check out their documentation](http://www.hazelcast.com/).\r\n\r\n### License ###\r\nAll aspects of this software are distributed under Apache Software License 2.0. See LICENSE file for full license text.\r\n\r\n### Contributors ###\r\n\r\n* Xavier Stevens ([@xstevens](http://twitter.com/xstevens))\r\n* Daniel Einspanjer ([@deinspanjer](http://twitter.com/deinspanjer))\r\n* Anurag Phadke ([@anuragphadke](http://twitter.com/anuragphadke))\r\n* Mark Reid ([@reid_write](http://twitter.com/reid_write))","tagline":"A REST API for Mozilla Metrics services.","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}